<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Chatbot T√©cnicas de Estudio</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f6f8;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        .chat-container {
            background: white;
            width: 900px;
            max-height: 90vh;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
        }
        .chat-header {
            background: #1f2937;
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
        }
        .chat-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }
        .bot {
            background: #e5e7eb;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            white-space: pre-wrap;
        }
        .user {
            background: #2563eb;
            color: white;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: right;
            white-space: pre-wrap;
        }
        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid #ddd;
            gap: 8px;
        }
        input {
            flex: 1;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        button {
            padding: 10px 12px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: white;
            cursor: pointer;
        }
            /* üü¢ Bot√≥n Enviar */
        #sendBtn {
            background: #16a34a; /* verde */
        }

        #sendBtn:hover {
            background: #15803d; /* verde m√°s oscuro */
        }

        /* Separaci√≥n entre botones y mensaje de cargando */
        #loading-msg {
            margin-top: 15px;
        }

        /* üé• VIDEO - naranja */
        .video-btn {
            background: #f97316; /* naranja */
        }
        .video-btn:hover {
            background: #ea580c;
        }
        .user.video-msg {
            background: #f97316;
        }

        /* üì∑ IMAGEN - rosa */
        .image-btn {
            background: #ec4899; /* rosa */
        }
        .image-btn:hover {
            background: #db2777;
        }
        .user.image-msg {
            background: #ec4899;
        }

        /* üéß AUDIO - violeta */
        .user.audio-msg {
            background: #7c3aed;
        }

        /* ‚ùå MENSAJES DE CANCELACI√ìN */
        .user.cancel-msg {
            background: #dc2626; /* rojo */
            color: white;
        }


    </style>
</head>
<body>

<div class="chat-container">
    <div class="chat-header">ü§ñ Chatbot de T√©cnicas de Estudio</div>
    <div class="chat-body" id="chat"></div>
    <div class="chat-input">
        <input type="text" id="input" placeholder="Escrib√≠ ac√°..." />

        <input type="file" id="imageInput" accept="image/*" style="display:none">
        <input type="file" id="videoInput" accept="video/*" style="display:none">
        <input type="file" id="audioInput" accept="audio/*" style="display:none">



        <button 
            id="imageBtn"
            class="image-btn"
            onclick="seleccionarImagen()"
            style="display:none"
        >
            üì∑ Imagen
        </button>
        <button 
            id="cancelImageBtn"
            onclick="cancelarImagen()"
            style="display:none; background:#dc2626;"
        >
            ‚ùå Cancelar imagen
        </button>

        <button 
            id="videoBtn"
            class="video-btn"
            onclick="seleccionarVideo()"
            style="display:none"
        >
            üé• Video
        </button>

        <button 
            id="cancelVideoBtn"
            onclick="cancelarVideo()"
            style="display:none; background:#dc2626;"
        >
            ‚ùå Cancelar video
        </button>

        <button 
            id="audioBtn"
            onclick="seleccionarAudio()"
            style="display:none; background:#7c3aed;"
        >
            üéß Audio
        </button>

        <button 
            id="cancelAudioBtn"
            onclick="cancelarAudio()"
            style="display:none; background:#dc2626;"
        >
            ‚ùå Cancelar audio
        </button>





        <button id="sendBtn" onclick="enviar()">Enviar</button>
    </div>
</div>

<script>
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    let state = {};
    let imagenPendiente = null;
    let videoPendiente = null;
    let audioPendiente = null;



    // üîπ Limpia SOLO error + botones de error (no toca el resto)
    function limpiarErrorYBotones() {
        const errorPrevio = document.getElementById("error-msg");
        if (errorPrevio) errorPrevio.remove();

        const botonesError = document.querySelector(".buttons.error-buttons");
        if (botonesError) botonesError.remove();
    }

    function agregarMensaje(texto, clase, esError = false) {
        if (esError) {
            limpiarErrorYBotones();
        }

        const div = document.createElement("div");
        div.className = clase;
        div.innerText = texto;

        if (esError) {
            div.id = "error-msg";
        }

        chat.appendChild(div);
        if (clase === "bot" && texto.length > 400) {
            chat.scrollTop = chat.scrollTop; // no baja
        } else {
            chat.scrollTop = chat.scrollHeight; // comportamiento normal
        }
    }

    function limpiarChat() {
        chat.innerHTML = "";
    }

    function mostrarCargando() {
        limpiarChat();
        agregarMensaje("‚è≥ Cargando, por favor esper√°...", "bot");
    }

    function mostrarCargandoInline() {
        const div = document.createElement("div");
        div.className = "bot";
        div.id = "loading-msg";
        div.innerText = "‚è≥ Cargando, por favor esper√°...";
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function actualizarBotonesMultimedia() {
        const imgBtn = document.getElementById("imageBtn");
        const vidBtn = document.getElementById("videoBtn");
        const audBtn = document.getElementById("audioBtn");

        if (!imgBtn || !vidBtn || !audBtn) return;

        if (state.tema) {
            imgBtn.style.display = "inline-block";
            vidBtn.style.display = "inline-block";
            audBtn.style.display = "inline-block";
        } else {
            imgBtn.style.display = "none";
            vidBtn.style.display = "none";
            audBtn.style.display = "none";
        }
    }

    function ocultarCancelaciones() {
        const btnImg = document.getElementById("cancelImageBtn");
        const btnVid = document.getElementById("cancelVideoBtn");
        const btnAud = document.getElementById("cancelAudioBtn");

        if (btnImg) btnImg.style.display = "none";
        if (btnVid) btnVid.style.display = "none";
        if (btnAud) btnAud.style.display = "none";
    }

    function mostrarBotonesDeNavegacion() {
        if (!state.year) return;
    
        const cont = document.createElement("div");
        cont.className = "buttons";
    
        const botones = ["üîô Volver a√±o"];
    
        if (state.materia) {
            botones.push("üìö Volver a materias");
        }
    
        if (state.tema) {
            botones.push("üìñ Elegir otro tema");
        }
    
        botones.forEach(b => {
            const btn = document.createElement("button");
            btn.innerText = b;
            btn.onclick = () => {
                if (b.includes("Volver a√±o")) enviar("volver a√±o");
                else if (b.includes("Volver a materias")) enviar("volver a materias");
                else if (b.includes("Elegir otro tema")) enviar("elegir otro tema");
            };
            cont.appendChild(btn);
        });
    
        chat.appendChild(cont);
    }
    

    async function enviar(mensajeForzado = null) {
        const mensaje = mensajeForzado ?? input.value.trim();

        // üîô Si viene de un bot√≥n de navegaci√≥n, limpiar todo antes
        if (mensajeForzado !== null) {
            imagenPendiente =null;
            videoPendiente = null;   // ‚¨ÖÔ∏è NUEVO
            audioPendiente = null; // üî• CLAVE
            ocultarCancelaciones(); // üëà ESTA ES LA CLAVE

            limpiarChat();
        }

        // üö´ Si es navegaci√≥n, NO pasar por multimedia
        if (mensajeForzado !== null) {
        // seguir directo al chat normal
        } 


        if (mensajeForzado === null && !mensaje && !audioPendiente) return;

        

        if (state.tema && mensajeForzado === null) {
            document.querySelectorAll(".buttons").forEach(b => b.remove());
        }

        input.value = "";
        // üñºÔ∏è Si hay imagen pendiente, se env√≠a junto con la consulta
if (imagenPendiente && mensajeForzado === null) {
    const pregunta = mensaje;
    if (!pregunta) return;

    agregarMensaje(pregunta, "user");
    mostrarCargandoInline();

    const formData = new FormData();
    formData.append("image", imagenPendiente);
    formData.append("question", pregunta);
    formData.append("state", JSON.stringify(state));

    imagenPendiente = null;
    const cancelBtn = document.getElementById("cancelImageBtn");
    if (cancelBtn) cancelBtn.style.display = "none";


    fetch("http://127.0.0.1:8000/chat-image-question", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();

        agregarMensaje(data.reply, "bot");
        state = data.state;
        actualizarBotonesMultimedia();

        if (data.buttons) {
            const cont = document.createElement("div");
            cont.className = "buttons";

            data.buttons.forEach(b => {
                const btn = document.createElement("button");
                btn.innerText = b;
                btn.onclick = () => {
                    if (b.includes("Volver a√±o")) enviar("volver a√±o");
                    else if (b.includes("Volver a materias")) enviar("volver a materias");
                    else if (b.includes("Elegir otro tema")) enviar("elegir otro tema");
                };
                cont.appendChild(btn);
            });

            chat.appendChild(cont);
        }
    });

    return;
}




// üé• SI HAY VIDEO PENDIENTE + PREGUNTA  ‚úÖ AC√Å
if (videoPendiente && mensajeForzado === null) {
    const pregunta = mensaje;
    if (!pregunta) return;

    agregarMensaje(pregunta, "user");
    mostrarCargandoInline();

    const formData = new FormData();
    formData.append("video", videoPendiente);
    formData.append("state", JSON.stringify(state));

    videoPendiente = null;
    const cancelBtn = document.getElementById("cancelVideoBtn");
    if (cancelBtn) cancelBtn.style.display = "none";


    fetch("http://127.0.0.1:8000/chat-video", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();

        agregarMensaje(data.reply, "bot");
        state = data.state;
        actualizarBotonesMultimedia();

        if (data.buttons) {
            const cont = document.createElement("div");
            cont.className = "buttons";

            data.buttons.forEach(b => {
                const btn = document.createElement("button");
                btn.innerText = b;
                btn.onclick = () => {
                    if (b.includes("Volver a√±o")) enviar("volver a√±o");
                    else if (b.includes("Volver a materias")) enviar("volver a materias");
                    else if (b.includes("Elegir otro tema")) enviar("elegir otro tema");
                };
                cont.appendChild(btn);
            });

            chat.appendChild(cont);
        }
    });

    return;
}

// üîä SI HAY AUDIO PENDIENTE
if (audioPendiente && mensajeForzado === null) {
    if (mensaje) {
        agregarMensaje(mensaje, "user"); // solo si hay texto
    }

    mostrarCargandoInline();

    const formData = new FormData();
    formData.append("audio", audioPendiente);
    formData.append("state", JSON.stringify(state));

    if (mensaje) {
        formData.append("question", mensaje); // üëà pregunta opcional
    }

    audioPendiente = null;
    document.getElementById("cancelAudioBtn").style.display = "none";

    fetch("http://127.0.0.1:8000/chat-audio", {
        method: "POST",
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();

        agregarMensaje(data.reply, "bot");
        state = data.state;
        actualizarBotonesMultimedia();

        if (data.buttons) {
            const cont = document.createElement("div");
            cont.className = "buttons";

            data.buttons.forEach(b => {
                const btn = document.createElement("button");
                btn.innerText = b;
                btn.onclick = () => {
                    if (b.includes("Volver a√±o")) enviar("volver a√±o");
                    else if (b.includes("Volver a materias")) enviar("volver a materias");
                    else if (b.includes("Elegir otro tema")) enviar("elegir otro tema");
                };
                cont.appendChild(btn);
            });

            chat.appendChild(cont);
        }
    });

    return;
}


        if (
            state.tema || 
            (state.materia && /^\d+$/.test(mensaje))
        ) {
            // ‚úÖ Mostrar la pregunta del usuario cuando ya hay tema
            if (state.tema && mensajeForzado === null) {
                
                agregarMensaje(mensaje, "user");
                
            }

            mostrarCargandoInline();
        }


        const res = await fetch("http://127.0.0.1:8000/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: mensaje, state })
        });

        const data = await res.json();

        const loading = document.getElementById("loading-msg");
        if (loading) loading.remove();

        const esError = data.reply.includes("Categor√≠a inv√°lida");

        if (!esError && data.buttons && !state.tema) {
            limpiarChat();
        }

        agregarMensaje(data.reply, "bot", esError);
        state = data.state;
        actualizarBotonesMultimedia();


        if (data.buttons) {
            if (esError) {
                document.querySelectorAll(".buttons").forEach(b => b.remove());
            }

            const cont = document.createElement("div");
            cont.className = "buttons" + (esError ? " error-buttons" : "");

            data.buttons.forEach(b => {
                const btn = document.createElement("button");
                btn.innerText = b;
                btn.onclick = () => {
                    if (b.includes("Volver a√±o")) enviar("volver a√±o");
                    else if (b.includes("Volver a materias")) enviar("volver a materias");
                    else if (b.includes("Elegir otro tema")) enviar("elegir otro tema");
                };
                cont.appendChild(btn);
            });

            chat.appendChild(cont);
        }
    }
    

    // =========================
    // üî• AGREGADO: ENV√çO DE IM√ÅGENES
    // =========================
    function seleccionarImagen() {
        document.getElementById("imageInput").click();
    }

    
    function seleccionarVideo() {
        document.getElementById("videoInput").click();
    }
    
    function cancelarImagen() {
        imagenPendiente = null;

        const btn = document.getElementById("cancelImageBtn");
        if (btn) btn.style.display = "none";
    
        // üîπ 1. Guardar botones actuales
        const botones = document.querySelectorAll(".buttons");
        botones.forEach(b => b.remove());
    
        // üîπ 2. Mostrar mensaje arriba
        const div = document.createElement("div");
        div.className = "user cancel-msg";
        div.innerText = "‚ùå Imagen cancelada.";
        div.style.marginTop = "10px";
        div.style.marginBottom = "15px";
    
        chat.appendChild(div);
    
        // üîπ 3. Volver a mostrar botones abajo
        mostrarBotonesDeNavegacion();
    
        chat.scrollTop = chat.scrollHeight;
    }

    function cancelarVideo() {
        videoPendiente = null;
    
        const btn = document.getElementById("cancelVideoBtn");
        if (btn) btn.style.display = "none";
    
        // üîπ 1. Quitar botones actuales
        const botones = document.querySelectorAll(".buttons");
        botones.forEach(b => b.remove());
    
        // üîπ 2. Mostrar mensaje arriba
        const div = document.createElement("div");
        div.className = "user cancel-msg";
        div.innerText = "‚ùå Video cancelado.";
        div.style.marginTop = "10px";
        div.style.marginBottom = "15px";
    
        chat.appendChild(div);
    
        // üîπ 3. Volver a mostrar botones abajo
        mostrarBotonesDeNavegacion();
    
        chat.scrollTop = chat.scrollHeight;
    }
    
    function seleccionarAudio() {
        document.getElementById("audioInput").click();
    }

    function cancelarAudio() {
        audioPendiente = null;

        const btn = document.getElementById("cancelAudioBtn");
        if (btn) btn.style.display = "none";

        document.querySelectorAll(".buttons").forEach(b => b.remove());
        agregarMensaje("‚ùå Audio cancelado.", "user cancel-msg");
        mostrarBotonesDeNavegacion();
    }


    document.getElementById("imageInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
    
        imagenPendiente = file;
    
        document.querySelectorAll(".buttons").forEach(b => b.remove());
        const div = document.createElement("div");
        div.className = "user image-msg";
        div.innerText = "üì∑ Imagen cargada.";
        chat.appendChild(div);
        
        
        document.getElementById("cancelImageBtn").style.display = "inline-block";
        //‚úÖ MOSTRAR BOTONES DE NAVEGACI√ìN
        mostrarBotonesDeNavegacion();
    
        this.value = "";
    });

    

    document.getElementById("videoInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;
    
        videoPendiente = file;
    
        document.querySelectorAll(".buttons").forEach(b => b.remove());
        const div = document.createElement("div");
        div.className = "user video-msg";
        div.innerText = "üé• Video cargado.";
        chat.appendChild(div);
    
        // üî¥ MOSTRAR bot√≥n cancelar video
        document.getElementById("cancelVideoBtn").style.display = "inline-block";
    
        // botones de navegaci√≥n abajo
        mostrarBotonesDeNavegacion();
    
        this.value = "";
    });
    
    document.getElementById("audioInput").addEventListener("change", function () {
        const file = this.files[0];
        if (!file) return;

        audioPendiente = file;

        document.querySelectorAll(".buttons").forEach(b => b.remove());
        const div = document.createElement("div");
        div.className = "user audio-msg";
        div.innerText = "üéß Audio cargado.";
        chat.appendChild(div);;

        document.getElementById("cancelAudioBtn").style.display = "inline-block";
        mostrarBotonesDeNavegacion();

        this.value = "";
    });


    // ‚úÖ MENSAJE INICIAL
    window.onload = () => {
        enviar("");
        actualizarBotonesMultimedia();
    };
</script>

</body>
</html>
